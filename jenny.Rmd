---
title: "jenny"
author: "Zoe Zhou"
date: "05/02/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Pressure values are records at a frequency of 50 Hz. 
## So 50 measurements per second. 
## 1 measurement every 20 milliseconds. 


```{r}
# Found the folder that contains jenny data
folder = list.files(pattern = "jenny", full = TRUE)
list.files(folder)

```

```{r}
(all.csv = list.files(folder, pattern = ".csv", full.names = TRUE))
```

```{r}
squeeze_and_hold = read.csv(all.csv[1])
colnames(squeeze_and_hold) = c("rectime", paste0("p", 1:8))

# Change rectime to ms
squeeze_and_hold$rectime = squeeze_and_hold$rectime * 1000
source("Functions.R")
```


```{r}
plot2(squeeze_and_hold, name = "Squeeze and hold data")
```

## df2 is the abient data
```{r eval = FALSE}
df2 = read.csv(all.csv[2])
colnames(df2) = c("rectime", paste0("p", 1:8), paste0("t", 1:8))
df2 = df2 %>% select(-(t1:t8))
plot2(df2)
```


## Remove baseline values using the first 3 seconds' data (we consider it as the relax period)
```{r}
first3seconds = getsubdata(squeeze_and_hold, stop = 3000)

colMeans(first3seconds[-1])
plot2(first3seconds, name = "first 3 seconds")
```


```{r}
change = baseline(squeeze_and_hold, first3seconds)
plot2(change, name = "Squeeze and hold (baseline removed)")

#ggsave("Squeeze and hold.png", height = 8, width = 16)
```


## df3 is the whole data
```{r}
df3 = read.csv(all.csv[3])
colnames(df3) = c("rectime", paste0("p", 1:8), paste0("t", 1:8))
df3 = df3 %>% select(-(t1:t8))

plot2(df3, name = "the whole recording")
```

## Get the peak pressure values
```{r}
change$peak = apply(change[, 1:8], 1, max)
```

## Try our old same method of smoothing
```{r}
tidydata = tidy(change)
lo.whole = loess(pressure ~ rectime, data = tidydata, span = 0.1)

plot(tidydata$rectime, tidydata$pressure, pch = 21, cex = 0.5)
lines(tidydata$rectime[order(tidydata$rectime)],
      predict(lo.whole)[order(tidydata$rectime)],
      col = "red", lwd = 2)
```

## Comment: Smoothing is not doing to well here. 
## we can still use smoothed.df but the peaks amplitudes are a bit small.

## Emphasize the peaks
```{r}
plot2(change) + geom_line(aes(x = rectime, y = peak), size = 1, col = "black")
```


## Preping for non greedy method
#### Get the top 20 peaks first. 

#### Note: changed minpeakdistane to 700 !!!!! Depends on the participant (time interval between contractions varies!!!!!!!!!!)
```{r}
top_20_peaks = findpeaks(change$peak, minpeakdistance = 700)
top_20_peaks_indices = sort(top_20_peaks[, 2])

### Check if we actually get 20
length(top_20_peaks_indices)

plot(change$peak, type = "l")
points(top_20_peaks[, 2], top_20_peaks[, 1], pch = 15, col = "red")
text(top_20_peaks[, 2] + 300, top_20_peaks[, 1] + 2, as.character(top_20_peaks[, 2]))
```

### Greedy method ###
#### Trying to get the 40 change points at once
```{r}
all.binseg = cpt.mean(change$peak, method = "BinSeg", Q = 40)
greedy.fit = cpts(all.binseg)
param.est(all.binseg)


plot(all.binseg)
```

### Doing pretty well!!!!!!!!!! Good job greedy!!!!

```{r}
greedy.fit
```


## For whole data (8 sensors) - Back to our original data
```{r}
mypoints = greedy.fit
```

## Just double check if we actually get the changepoints right (can manually modify a bit here ig needed)
```{r}
start.end.rectime = change$rectime[mypoints] 

plot2(change) + theme_void() + 
  geom_vline(xintercept = start.end.rectime)

```

## Let's have a look at each individual contraction !!!!

```{r}
for (i in 1:20) {
  start = start.end.rectime[i*2 - 1]
  end = start.end.rectime[i*2]
  

  print(myplot(getsubdata(change, start, end), name = paste0("Contraction No.", i)) + 
          theme_classic() + 
          theme(axis.text = element_text(face = "bold", size = 14),
                axis.title = element_text(face = "bold", size = 14)))
  
  #ggsave(paste0("Contraction No.", i, ".png"), height = 5, width = 8)
}


```












