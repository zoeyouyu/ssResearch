---
title: "s0009"
author: "Zoe Zhou"
date: "31/01/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
# Found the folder that contains patient data s0009
folders = list.files(pattern = "_csv")
folder = folders[grep("_9_", folders)]

# Process the folder, get df.list (containing 3 datasets)
source("Functions.R")
df.list = process(folder)
data = df.list[[1]]
```


```{r}
myplot(data, name = names(df.list)[1])

# Check where is the crazy data (> 800) at the end
end = round(grep("FALSE", data[-1] < 800)[1] / 8)

# Get rid of that crazy part and plot
data[1:(end-50), ] %>% myplot(name = names(df.list)[1])
```

##### Remove the baseline and plot the whole
```{r}
myplot(df.list[[2]][1:(end-50), ], name = names(df.list)[2])
```

##### Get the pfmc data and plot it
```{r}
myplot(df.list[[3]], name = names(df.list)[3])
```
##### Remove the baseline and plot it
```{r}
myplot(df.list[[4]], name = names(df.list)[4])
```

##### Create a new time variable, and add a axis labelling in seconds
---Create a new time variable , by subtracting the recording time variable by its starting time (the minimal value)

```{r}
pfmcdata = df.list[[3]]
pfmcdata$time = pfmcdata$rectime - min(pfmcdata$rectime)
```

---Note, there are some missingness in the data (time gap is not always 10 ms) 

** This might cause a slipperage in data (a drastic drop)

** E.g. TIME = 50 to 90 time gap is 40ms, we lost the data in between **
```{r}
recno = ifelse(diff(pfmcdata$rectime) == 10, "good", NA)
# Give the last one NaN
pfmcdata$isna = as.factor(c(recno, NaN))
summary(pfmcdata$isna)
```

Apparently, we have 90 missing values. But so far, it does not affect our plotting.

### For PFMC change data, we wanna dive closer to see each contraction
### To get smoothed.df to reduce the effect of noise (the smoothed line captures the pattern of trace fairly well)
```{r}
change = df.list[[4]]
change$id = 1:nrow(change)


change$time = change$rectime - min(change$rectime)
```

## Clean out the problem noisy data
```{r}
problem = change %>% filter(change$rectime > min(change$rectime) + 24000,
                  change$rectime < min(change$rectime) + 30000)


change[problem$id, 1:8] = 0


myplot(change)
```


```{r}
tidydata = tidy(change)
lo.whole = loess(pressure ~ rectime, data = tidydata, span = 0.1)
plot(tidydata$rectime, tidydata$pressure, pch = 21, cex = 0.5)

lines(tidydata$rectime[order(tidydata$rectime)],
      predict(lo.whole)[order(tidydata$rectime)],
      col = "red", lwd = 2)
```


```{r}
# Get smoothed.df
smoothed.df = unique(data.frame(rectime = tidydata$rectime[order(tidydata$rectime)], 
                            pressure = predict(lo.whole)[order(tidydata$rectime)]))
smoothed.df$id = 1:nrow(smoothed.df)

# Plot the smooth line
ggplot(data = tidydata) +
  geom_line(aes(x = rectime, y = pressure, color = sensor)) +
  geom_line(data = smoothed.df, aes(x = rectime, y = pressure), size = 1) +
  labs(x = "Recording Time (in s)", y = "Pressure Change (in mm Hg)",
       title = "Pressure trace from all sensors with smoothed line") +
  guides(color = guide_legend(override.aes = list(size = 5)))

#ggsave("Colored Pressure traces with Smoothed Line.png", width = 10, height = 4)
```

```{r}
# Get the baseline noise
noise = smoothed.df %>% 
  filter(rectime < min(rectime + 15000)) %>%
  summarise(maxdiff = max(pressure) - min(pressure)) %>%
  as.numeric()
```


### Use the non-greedy (Patience is virtue) method to find 6 change points
```{r}
#### Get the top 3 peaks first. 
top_3_peaks = findpeaks(smoothed.df$pressure, minpeakdistance = 500, minpeakheight = noise)
top_3_peaks_indices = sort(top_3_peaks[, 2])
plot(smoothed.df$pressure, type = "l")
points(top_3_peaks[, 2], top_3_peaks[, 1], pch = 15, col = "red")
text(top_3_peaks[, 2] + 250, top_3_peaks[, 1], as.character(top_3_peaks[, 2]))
```


#### Segment1 is from the start to the 1st peak. Return the 1st peak start point. (point 1)
```{r}
seg1.test = cpt.meanvar(smoothed.df[1:top_3_peaks_indices[1], "pressure"])
point1 = cpts(seg1.test)
plot(seg1.test)
text(cpts(seg1.test), 0, cpts(seg1.test), font = 2)
```
#### Segment2 is from point1 to the 2nd peak. Return the 1st peak end point. (point 2)

#### Need to change the x axis
```{r}
seg2.test = cpt.mean(smoothed.df[point1:top_3_peaks_indices[2], "pressure"])
point2 = point1 + cpts(seg2.test)
plot(seg2.test)
text(cpts(seg2.test), 0, point2, font = 2)
```
#### Segment3 is from point2 to 2nd peak. Return the 2nd peak start point. (point 3)

#### Need to change the x axis
```{r}
seg3.test = cpt.meanvar(smoothed.df[point2:top_3_peaks_indices[2], "pressure"])
point3 = point2 + cpts(seg3.test)
plot(seg3.test)
text(cpts(seg3.test), 0, point3, font = 2)
```

#### Segment4 is from point3 to 3rd peak. Return the 2nd peak end point. (point 4)

#### Need to change the x axis
```{r}
seg4.test = cpt.meanvar(smoothed.df[point3:top_3_peaks_indices[3], "pressure"])
point4 = point3 + cpts(seg4.test)
plot(seg4.test)
text(cpts(seg4.test), 1.5, point4, font = 2)
```

#### Segment5 is from point4 to 3rd peak. Return the 3rd peak start point. (point 5)

#### Need to change the x axis
```{r}
seg5.test = cpt.meanvar(smoothed.df[point4:top_3_peaks_indices[3], "pressure"])
point5 = point4 + cpts(seg5.test)
plot(seg5.test)
text(cpts(seg5.test), 0.5, point5, font = 2)
```

#### Segment6 is from point5 to the end. Return the 3rd peak end point. (point 6)

#### Need to change the x axis
```{r}
seg6.test = cpt.mean(smoothed.df[point5:nrow(smoothed.df), "pressure"])

point6 = ifelse(length(cpts(seg6.test)) == 0, nrow(data), cpts(seg6.test)+point5)
print(ifelse(length(cpts(seg6.test)) == 0, "We don't have point 6", paste("We have Point 6 at", point6)))
```


```{r}
plot(seg6.test)
text(cpts(seg6.test), 2, point6, font = 2)
```


## For whole data (8 sensors) - Back to our original data
```{r}
mypoints = c(point1, point2, point3, point4, point5, point6)
                
mypoints[1] = mypoints[1] + 40
mypoints[2] = mypoints[2] + 50

mypoints[5] = mypoints[5] - 50


start.end.rectime = smoothed.df$rectime[mypoints] 

ggplot(data = tidydata) +
  geom_line(aes(x = rectime, y = pressure, color = sensor)) +
  geom_vline(xintercept = start.end.rectime)

```

## Let's have a look at each individual contraction !!!!

```{r}
#babyplots.p3 = list()
for (i in 1:3) {
  start = start.end.rectime[i*2 - 1]
  end = start.end.rectime[i*2]
  
  # Each contraction original
  #print(myplot(getsubdata(data, start, end), name = names(df.list)[4]) + 
          #labs(subtitle = paste0("pfmc no.", i)) + theme_classic())

  # Each contraction baseline removed
  #babyplots.p3[[i]] = myplot(getsubdata(df.list[[4]], start, end)) + theme_classic()
  print(myplot(getsubdata(df.list[[4]], start, end), name = paste0("Contraction No.", i)) + 
          theme_classic() + 
          theme(axis.text = element_text(face = "bold", size = 14),
                axis.title = element_text(size = 20, face = "bold")))
  #ggsave(paste0("Contraction No.", i, ".png"), height = 5, width = 8)
}

```









